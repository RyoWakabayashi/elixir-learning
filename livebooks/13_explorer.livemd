# Explorer

```elixir
Mix.install([
  {:explorer, "~> 0.3"},
  {:kino, "~> 0.7"}
])
```

## Section

```elixir
alias Explorer.DataFrame
alias Explorer.Series
```

```elixir
population_df = DataFrame.from_csv!("/home/livebook/population_20211001.csv")
```

```elixir
DataFrame.table(population_df)
```

```elixir
DataFrame.table(population_df, limit: :infinity)
```

```elixir
population_df
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
population_df
|> DataFrame.distinct(["年齢層"])
|> DataFrame.to_columns()
|> Map.get("年齢層")
```

```elixir
population_df
|> DataFrame.filter_with(&Series.equal(&1["都道府県"], "東京都"))
|> DataFrame.select(["年齢層", "性別", "人口（千人）"])
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
population_df
|> DataFrame.mutate_with(fn df ->
  [
    "人口（千人）": Series.cast(df["人口（千人）"], :float)
  ]
end)
|> DataFrame.filter_with(&Series.equal(&1["都道府県"], "東京都"))
|> DataFrame.select(["年齢層", "性別", "人口（千人）"])
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
trim_comma = fn input ->
  String.replace(input, ",", "")
end

population_df
|> DataFrame.mutate("人口（千人）": &Series.transform(&1["人口（千人）"], trim_comma))
|> DataFrame.mutate_with(fn df ->
  [
    "人口（千人）": Series.cast(df["人口（千人）"], :float)
  ]
end)
|> DataFrame.filter_with(&Series.equal(&1["都道府県"], "東京都"))
|> DataFrame.select(["年齢層", "性別", "人口（千人）"])
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
population_df =
  population_df
  |> DataFrame.mutate("人口（千人）": &Series.transform(&1["人口（千人）"], trim_comma))
  |> DataFrame.mutate_with(fn df ->
    [
      "人口（千人）": Series.cast(df["人口（千人）"], :float)
    ]
  end)
  |> DataFrame.mutate_with(fn df ->
    [
      "人口（千人）": Series.multiply(df["人口（千人）"], 1000)
    ]
  end)
  |> DataFrame.mutate_with(fn df ->
    [
      "人口（千人）": Series.cast(df["人口（千人）"], :integer)
    ]
  end)
  |> DataFrame.rename("人口（千人）": "人口")

population_df
|> DataFrame.filter_with(&Series.equal(&1["都道府県"], "東京都"))
|> DataFrame.select(["年齢層", "性別", "人口"])
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
population_df
|> DataFrame.filter_with(&Series.equal(&1["年齢層"], "15歳未満"))
|> DataFrame.filter_with(&Series.equal(&1["性別"], "男性"))
|> DataFrame.filter_with(&Series.greater(&1["人口"], 300_000))
|> DataFrame.select(["都道府県", "人口"])
|> DataFrame.arrange(desc: "人口")
|> DataFrame.to_rows()
|> Kino.DataTable.new()
```

```elixir
population_df
|> DataFrame.mutate_with(fn df ->
  [
    "人口（千人）": Series.cast(df["人口"], :integer)
  ]
end)
|> DataFrame.pivot_wider("年齢層", "人口")
|> DataFrame.to_rows()
|> Kino.DataTable.new()
```

```elixir
sum_df =
  population_df
  |> DataFrame.group_by(["都道府県"])
  |> DataFrame.summarise(人口: [:sum])
  |> DataFrame.rename(人口_sum: "人口")
  |> DataFrame.mutate_with(fn df ->
    [
      "人口（千人）": Series.cast(df["人口"], :float)
    ]
  end)

sum_df
|> DataFrame.arrange(desc: "人口")
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
sex_ratio_df =
  population_df
  |> DataFrame.group_by(["都道府県", "性別"])
  |> DataFrame.summarise(人口: [:sum])
  |> DataFrame.rename(人口_sum: "人口")
  |> DataFrame.mutate_with(fn df ->
    [
      人口: Series.cast(df["人口"], :float)
    ]
  end)
  |> DataFrame.pivot_wider("性別", "人口")
  |> DataFrame.mutate_with(fn df ->
    [
      合計: Series.add(df["男性"], df["女性"])
    ]
  end)
  |> DataFrame.mutate_with(fn df ->
    [
      男性率: Series.divide(df["男性"], df["合計"])
    ]
  end)
  |> DataFrame.mutate_with(fn df ->
    [
      女性率: Series.divide(df["女性"], df["合計"])
    ]
  end)
  |> DataFrame.select(["都道府県", "男性率", "女性率"])

sex_ratio_df
|> DataFrame.arrange(desc: "男性率")
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
elderly_rate_df =
  population_df
  |> DataFrame.group_by(["都道府県", "年齢層"])
  |> DataFrame.summarise(人口: [:sum])
  |> DataFrame.rename(人口_sum: "人口")
  |> DataFrame.mutate_with(fn df ->
    [
      人口: Series.cast(df["人口"], :float)
    ]
  end)
  |> DataFrame.pivot_wider("年齢層", "人口")
  |> DataFrame.mutate_with(fn df ->
    [
      合計: Series.add(df["15歳未満"], df["15～64歳"])
    ]
  end)
  |> DataFrame.mutate_with(fn df ->
    [
      合計: Series.add(df["合計"], df["65歳以上"])
    ]
  end)
  |> DataFrame.mutate_with(fn df ->
    [
      高齢者率: Series.divide(df["65歳以上"], df["合計"])
    ]
  end)
  |> DataFrame.select(["都道府県", "高齢者率"])

elderly_rate_df
|> DataFrame.arrange(desc: "高齢者率")
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
assets_df = DataFrame.from_csv!("/home/livebook/assets_20151216.csv")
```

```elixir
assets_df
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
parse_float = fn df, col ->
  df
  |> DataFrame.mutate(%{col => &Series.transform(&1[col], trim_comma)})
  |> DataFrame.mutate(%{col => &Series.cast(&1[col], :float)})
end

assets_df =
  assets_df
  |> parse_float.("年間収入")
  |> parse_float.("貯蓄現在高")
  |> parse_float.("負債現在高")

assets_df
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
joined_df =
  sum_df
  |> DataFrame.join(sex_ratio_df, how: :left)
  |> DataFrame.join(elderly_rate_df, how: :left)
  |> DataFrame.join(assets_df, how: :left)

joined_df
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
DataFrame.to_csv(joined_df, "/tmp/joined.csv")
```

```elixir
joined_df
|> DataFrame.arrange(desc: "高齢者率")
|> DataFrame.to_rows()
|> Kino.DataTable.new(sorting_enabled: true)
```

```elixir
cols = ["人口", "男性率", "女性率", "高齢者率", "世帯人員", "持ち家率", "年間収入", "貯蓄現在高"]
```

```elixir
std_map =
  joined_df
  |> DataFrame.select(cols)
  |> DataFrame.to_series()
  |> Enum.map(fn {key, value} -> {key, Series.std(value)} end)
  |> Enum.into(%{})
```

```elixir
get_mul = fn df, col_1, col_2 ->
  DataFrame.mutate(df, %{(col_1 <> "*" <> col_2) => &Series.multiply(&1[col_1], &1[col_2])})
end

covariance_df =
  cols
  |> Enum.reduce(joined_df, fn col_1, sub_df_1 ->
    cols
    |> Enum.reduce(sub_df_1, fn col_2, sub_df_2 ->
      get_mul.(sub_df_2, col_1, col_2)
    end)
  end)
```

```elixir
mean_map =
  covariance_df
  |> DataFrame.select(["都道府県"], :drop)
  |> DataFrame.to_series()
  |> Enum.map(fn {key, value} -> {key, Series.mean(value)} end)
  |> Enum.into(%{})
```

```elixir
get_covariance = fn col_1, col_2 ->
  Map.get(mean_map, col_1 <> "*" <> col_2) - Map.get(mean_map, col_1) * Map.get(mean_map, col_2)
end

covariance_map =
  cols
  |> Enum.map(fn col_1 ->
    cols
    |> Enum.map(fn col_2 ->
      {col_1 <> "*" <> col_2, get_covariance.(col_1, col_2)}
    end)
    |> Enum.into(%{})
  end)
  |> Enum.reduce(fn map, merged_map ->
    Map.merge(merged_map, map)
  end)
```

```elixir
get_correlation = fn col_1, col_2 ->
  cond do
    col_1 == col_2 ->
      1

    true ->
      Map.get(covariance_map, col_1 <> "*" <> col_2) /
        (Map.get(std_map, col_1) * Map.get(std_map, col_2))
  end
end

correlation_map =
  cols
  |> Enum.map(fn col_1 ->
    cols
    |> Enum.map(fn col_2 ->
      {col_1 <> "*" <> col_2, get_correlation.(col_1, col_2)}
    end)
    |> Enum.into(%{})
  end)
  |> Enum.reduce(fn map, merged_map ->
    Map.merge(merged_map, map)
  end)
```

```elixir
cols
|> Enum.map(fn col_1 ->
  %{
    col_1 =>
      cols
      |> Enum.map(fn col_2 ->
        Map.get(covariance_map, col_1 <> "*" <> col_2)
      end)
  }
end)
|> Enum.reduce(fn map, merged_map ->
  Map.merge(merged_map, map)
end)
|> Map.merge(%{"x" => cols})
|> DataFrame.new()
|> DataFrame.select(["x" | cols])
|> DataFrame.to_rows()
|> Kino.DataTable.new(keys: ["x" | cols], sorting_enabled: true)
```

```elixir
cols
|> Enum.map(fn col_1 ->
  %{
    col_1 =>
      cols
      |> Enum.map(fn col_2 ->
        Map.get(correlation_map, col_1 <> "*" <> col_2)
      end)
  }
end)
|> Enum.reduce(fn map, merged_map ->
  Map.merge(merged_map, map)
end)
|> Map.merge(%{"x" => cols})
|> DataFrame.new()
|> DataFrame.select(["x" | cols])
|> DataFrame.to_rows()
|> Kino.DataTable.new(keys: ["x" | cols], sorting_enabled: true)
```
